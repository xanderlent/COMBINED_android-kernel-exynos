default: all

KBUILD_OPTIONS := BCMDHD_ROOT=$(shell cd $(KERNEL_SRC); readlink -e $(M))
KBUILD_OPTIONS += CONFIG_BCMDHD=m
KBUILD_OPTIONS += CONFIG_BCMDHD_SDIO=y
KBUILD_OPTIONS += CONFIG_BCM43013=y
KBUILD_OPTIONS += CONFIG_DHD_OF_SUPPORT=y
KBUILD_OPTIONS += CONFIG_BCMDHD_FW_PATH="\"/firmware/fw_bcmdhd.bin\""
KBUILD_OPTIONS += CONFIG_BCMDHD_NVRAM_PATH="\"/etc/wifi/bcmdhd.cal\""
KBUILD_OPTIONS += CONFIG_BCMDHD_CLM_PATH="\"/etc/wifi/bcmdhd_clm.blob\""
KBUILD_OPTIONS += CONFIG_BROADCOM_WIFI_RESERVED_MEM=y
KBUILD_OPTIONS += CONFIG_BCMDHD_PREALLOC_MEMDUMP=y
KBUILD_OPTIONS += CONFIG_BCMDHD_OOB_HOST_WAKE=y
KBUILD_OPTIONS += CONFIG_DHD_USE_STATIC_BUF=y

# Parsing doesn't happen for all flags in Kbuild; so parsing them all here to make sure.
KBUILD_FLAGS := -DCONFIG_BCMDHD
KBUILD_FLAGS += -DCONFIG_BCMDHD_SDIO
KBUILD_FLAGS += -DCONFIG_BCM43013
KBUILD_FLAGS += -DCONFIG_DHD_OF_SUPPORT
KBUILD_FLAGS += -DCONFIG_BCMDHD_FW_PATH="\"/firmware/fw_bcmdhd.bin\""
KBUILD_FLAGS += -DCONFIG_BCMDHD_NVRAM_PATH="\"/etc/wifi/bcmdhd.cal\""
KBUILD_FLAGS += -DCONFIG_BCMDHD_CLM_PATH="\"/etc/wifi/bcmdhd_clm.blob\""
KBUILD_FLAGS += -DCONFIG_BROADCOM_WIFI_RESERVED_MEM
KBUILD_FLAGS += -DCONFIG_BCMDHD_PREALLOC_MEMDUMP
KBUILD_FLAGS += -DCONFIG_BCMDHD_OOB_HOST_WAKE
KBUILD_FLAGS += -DCONFIG_DHD_USE_STATIC_BUF
KBUILD_FLAGS += -DANDROID_PLATFORM_VERSION=11

# Debug flag. This flag is only used in KBuild.
# Comment out to disable debugging logs and processes.
# STOPSHIP: 188463502 disable CONFIG_BCMDHD_DEBUG.
KBUILD_OPTIONS += CONFIG_BCMDHD_DEBUG=y

all:
	$(MAKE) -C $(KERNEL_SRC) M=$(M) modules $(KBUILD_OPTIONS) KCFLAGS='$(KBUILD_FLAGS)'

modules_install:
	$(MAKE) INSTALL_MOD_STRIP=1 M=$(M) -C $(KERNEL_SRC) modules_install

clean::
	rm -f *.o *.ko *.mod.c *.mod.o *~ .*.cmd Module.symvers
	rm -rf .tmp_versions
